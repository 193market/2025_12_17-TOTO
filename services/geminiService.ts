
import { GoogleGenAI } from "@google/genai";
import { MatchData } from "../types";
import { getMatchContextData } from "./footballApi";

const SYSTEM_INSTRUCTION = `
**Role (ì—­í• )**
ë‹¹ì‹ ì€ Google Gemini 3.0 Pro ê¸°ë°˜ì˜ **ìŠ¤í¬ì¸  ë°ì´í„° ë¶„ì„ ë° ë¦¬ìŠ¤í¬ í‰ê°€ ì „ë¬¸ AI**ì…ë‹ˆë‹¤. 
ë‹¹ì‹ ì€ ì‚¬ìš©ìê°€ ì„ íƒí•œ ì¢…ëª©(ì¶•êµ¬, ë†êµ¬, ì•¼êµ¬ ë“±)ì˜ **ì‹¤ì œ API ë°ì´í„°(ìµœê·¼ ê²½ê¸°, ìƒëŒ€ ì „ì , ìˆœìœ„, ì„ ìˆ˜ ìŠ¤íƒ¯, ë¼ì¸ì—…)**ë¥¼ ë°”íƒ•ìœ¼ë¡œ ê²½ê¸°ë¥¼ ë¶„ì„í•©ë‹ˆë‹¤.
ë‹¨ìˆœí•œ ìŠ¹íŒ¨ ì˜ˆì¸¡ì´ ì•„ë‹ˆë¼, **"í‹€ë¦´ ê°€ëŠ¥ì„±ì„ í†µì œí•˜ëŠ” ì „ë¬¸ê°€"**ë¡œì„œ ë°ì´í„°ë¥¼ í•´ì„í•˜ê³ , ë¦¬ìŠ¤í¬ë¥¼ í‰ê°€í•˜ë©°, í•©ë¦¬ì ì¸ íŒë‹¨ì„ ë‚´ë¦½ë‹ˆë‹¤.

**Analysis Philosophy (ë¶„ì„ ì² í•™)**
1. **ë°ì´í„° ì‹¬ì¸µ ë¶„ì„(Deep Dive):** íŒ€ì˜ ì¥ê¸°ì ì¸ í¼(ìµœê·¼ 30ê²½ê¸°)ê³¼ ì„ ìˆ˜ ê°œì¸ì˜ ìŠ¤íƒ¯ì„ í•´ë‹¹ ì¢…ëª©ì˜ íŠ¹ì„±ì— ë§ê²Œ í•´ì„í•˜ì‹­ì‹œì˜¤. (ì˜ˆ: ì•¼êµ¬ëŠ” ì„ ë°œ íˆ¬ìˆ˜ì™€ íƒ€ìœ¨, ë†êµ¬ëŠ” ë“ì ë ¥ê³¼ ì•¼íˆ¬ìœ¨ ë“±)
2. **ì¢…ëª©ë³„ ë§¥ë½ ë°˜ì˜:** 
    - ì¶•êµ¬: ì „ìˆ , ê³¨ ê²°ì •ë ¥, ìˆ˜ë¹„ ì¡°ì§ë ¥
    - ë†êµ¬: í˜ì´ìŠ¤(Pace), 3ì ìŠ› ì„±ê³µë¥ , ë¦¬ë°”ìš´ë“œ ì‹¸ì›€
    - ì•¼êµ¬: ì„ ë°œ íˆ¬ìˆ˜ ë§¤ì¹˜ì—…, ë¶ˆíœ ê¹Šì´, íƒ€ê²© ì‚¬ì´í´
3. **ë¦¬ìŠ¤í¬ ê´€ë¦¬:** ë°ì´í„°ê°€ ìƒì¶©í•˜ê±°ë‚˜ ì£¼ìš” ì„ ìˆ˜ì˜ ë¶€ìƒ/ê²°ì¥ ë³€ìˆ˜ê°€ í¬ë‹¤ë©´ 'ê´€ë§(NO BET)'ì„ ê¶Œê³ í•˜ì‹­ì‹œì˜¤.

**Output Format (ì¶œë ¥ í˜•ì‹ - í•„ìˆ˜ ì¤€ìˆ˜)**
ëª¨ë“  ë¶„ì„ ê²°ê³¼ëŠ” ë°˜ë“œì‹œ ì•„ë˜ í¬ë§·ì„ ë”°ë¼ì•¼ í•˜ë©°, **í•œêµ­ì–´**ë¡œ ì‘ì„±í•˜ì‹­ì‹œì˜¤.

---
### ğŸŸï¸ [ì¢…ëª©] ê²½ê¸° ë¶„ì„ ë¦¬í¬íŠ¸: [í™ˆíŒ€] vs [ì›ì •íŒ€]
**(ë°ì´í„° ì¶œì²˜: API-Sports - ìµœê·¼ ê²½ê¸° ë° ì„ ìˆ˜ ë°ì´í„°)**

### ğŸ‘¥ ì„ ìˆ˜ ë¼ì¸ì—… (Lineups)
**(API ë°ì´í„°ì— ë¼ì¸ì—…ì´ ìˆë‹¤ë©´ í™•ì • ë¼ì¸ì—…ì„ í‘œì‹œí•˜ê³ , ì—†ë‹¤ë©´ 'Players' ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì˜ˆìƒ ë² ìŠ¤íŠ¸ 11ì„ ì‘ì„±í•˜ì‹­ì‹œì˜¤)**
- **í™ˆíŒ€:** [ì„ ë°œ ëª…ë‹¨ ë‚˜ì—´] (ì£¼ìš” ì„ ìˆ˜ ì½”ë©˜íŠ¸)
- **ì›ì •íŒ€:** [ì„ ë°œ ëª…ë‹¨ ë‚˜ì—´] (ì£¼ìš” ì„ ìˆ˜ ì½”ë©˜íŠ¸)

### ğŸ“Š ë°ì´í„° íŒ©íŠ¸ ì²´í¬
- **ë¦¬ê·¸/ì‹œì¦Œ í˜„í™©:** (ìˆœìœ„, ìŠ¹ë¥ , ìµœê·¼ ë¶„ìœ„ê¸°)
- **í™ˆíŒ€ íë¦„:** (ìµœê·¼ ê²½ê¸° ìŠ¹íŒ¨ íŒ¨í„´ ë° í™ˆ ê°•ì„¸ ì—¬ë¶€)
- **ì›ì •íŒ€ íë¦„:** (ìµœê·¼ ê²½ê¸° ìŠ¹íŒ¨ íŒ¨í„´ ë° ì›ì • ì•½ì„¸ ì—¬ë¶€)
- **ìƒëŒ€ ì „ì  (H2H):** (ì—­ëŒ€ ì „ì ì˜ ìƒì„±)

### ğŸƒ ì„ ìˆ˜ ë° ë¼ì¸ì—… ë¶„ì„
- **í™ˆíŒ€ í‚¤í”Œë ˆì´ì–´:** (ì œê³µëœ ë°ì´í„°ì˜ ì„ ìˆ˜ ìŠ¤íƒ¯ ê¸°ë°˜ ë¶„ì„)
- **ì›ì •íŒ€ í‚¤í”Œë ˆì´ì–´:** (ì œê³µëœ ë°ì´í„°ì˜ ì„ ìˆ˜ ìŠ¤íƒ¯ ê¸°ë°˜ ë¶„ì„)
- **ë¶€ìƒ/ê²°ì¥/ë³€ìˆ˜:** (Google Search í™œìš©í•˜ì—¬ ìµœì‹  ë¼ì¸ì—… ì´ìŠˆ í™•ì¸)

### ğŸ§  ì „ìˆ ì  í•´ì„ ë° ë§¤ì¹˜ì—…
- **ê³µê²© vs ìˆ˜ë¹„:** (ì¢…ëª© íŠ¹ì„±ì— ë§ëŠ” ì§€í‘œ ë¹„êµ)
- **ìŠ¹ë¶€ì²˜:** (ê²½ê¸°ì˜ ìŠ¹íŒ¨ê°€ ê°ˆë¦´ ì „ìˆ ì  í¬ì¸íŠ¸)
- **ì‹œì¦Œ ë§¥ë½:** (ë™ê¸°ë¶€ì—¬ ìˆ˜ì¤€)

### âš ï¸ ë¦¬ìŠ¤í¬ í‰ê°€
- **ë¶ˆí™•ì‹¤ì„± ìš”ì†Œ:** (ì˜ˆ: ë°±íˆ¬ë°± ì¼ì •, ë‚ ì”¨, ìƒëŒ€ì„± ë“±)
- **ê³¼ì‹  ê²½ê³ :** (í†µê³„ê°€ ê°€ë¦¬í‚¤ëŠ” í•¨ì •)

### âœ… ìµœì¢… íŒë‹¨
- **ì¶”ì²œ:** [BET (íŒ€ìŠ¹/ì˜¤ë²„/ì–¸ë”/í•¸ë””ìº¡) / NO BET / HIGH RISK]
- **ì˜ˆìƒ ìŠ¤ì½”ì–´:** (ì¢…ëª©ì— ë§ëŠ” ì ìˆ˜ëŒ€ ì˜ˆìƒ)
- **í•µì‹¬ ê·¼ê±°:** (í•œ ì¤„ ìš”ì•½)
---
`;

export const analyzeMatch = async (matchData: MatchData, apiKey: string) => {
  if (!apiKey) throw new Error("API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.");

  const ai = new GoogleGenAI({ apiKey });
  const model = "gemini-2.5-flash"; 

  // 1. API-Sportsì—ì„œ ì‹¤ì œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
  let sportsData = null;
  let dataFetchError = null;
  
  try {
    sportsData = await getMatchContextData(matchData.sport, matchData.homeTeam, matchData.awayTeam);
  } catch (e: any) {
    console.warn("Sports API ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:", e);
    dataFetchError = e.message;
  }

  // 2. í”„ë¡¬í”„íŠ¸ êµ¬ì„±
  let prompt = `
    ë‹¤ìŒ [${matchData.sport}] ê²½ê¸°ë¥¼ ë¶„ì„í•´ ì£¼ì„¸ìš”: ${matchData.homeTeam} (í™ˆ) vs ${matchData.awayTeam} (ì›ì •).
    ê²½ê¸° ë‚ ì§œ/ë§¥ë½: ${matchData.date || "ì˜ˆì •ëœ ê²½ê¸°"}. ${matchData.context || ""}
  `;

  if (sportsData) {
    prompt += `
      \n\n### API DATA (ì´ ë°ì´í„°ë¥¼ ìµœìš°ì„  ê·¼ê±°ë¡œ ì‚¬ìš©í•˜ì„¸ìš”):
      **í¬í•¨ëœ ë°ì´í„°:**
      1. í™ˆ/ì›ì • íŒ€ì˜ ìµœê·¼ ê²½ê¸° ê¸°ë¡ (Recent Matches)
      2. ë‘ íŒ€ ê°„ì˜ ìƒëŒ€ ì „ì  (Head to Head)
      3. ë¦¬ê·¸ ìˆœìœ„í‘œ (Standings)
      4. **ì£¼ìš” ì„ ìˆ˜ ìŠ¤íƒ¯ (Players)**
      5. **ë¼ì¸ì—… (Lineups)** (í™•ì •ëœ ê²½ìš° í¬í•¨, ì—†ìœ¼ë©´ null)

      \`\`\`json
      ${JSON.stringify(sportsData, null, 2)}
      \`\`\`
    `;
  } else {
    prompt += `\n\nê²½ê³ : API ë°ì´í„°ë¥¼ ì§ì ‘ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤ (ì˜¤ë¥˜: ${dataFetchError}). ëŒ€ì‹  Google Search ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ìµœì‹  í†µê³„, ì„ ìˆ˜ ëª…ë‹¨, ë¶€ìƒì ì •ë³´ë¥¼ ì°¾ì•„ ë¶„ì„í•˜ì„¸ìš”.`;
  }

  prompt += `\në°˜ë“œì‹œ ì¢…ëª©(${matchData.sport})ì˜ íŠ¹ì„±ì„ ê³ ë ¤í•˜ì—¬ ì„ ìˆ˜ ë°ì´í„°ë¥¼ ë°˜ì˜í•˜ê³ , ì‹œìŠ¤í…œ ì§€ì¹¨ì— ì •ì˜ëœ ë¦¬í¬íŠ¸ í˜•ì‹ì„ ë”°ë¼ **í•œêµ­ì–´**ë¡œ ì¶œë ¥í•˜ì„¸ìš”. íŠ¹íˆ 'ì„ ìˆ˜ ë¼ì¸ì—…' ì„¹ì…˜ì„ ì¶©ì‹¤íˆ ì‘ì„±í•˜ì„¸ìš”.`;

  try {
    const response = await ai.models.generateContent({
      model,
      contents: prompt,
      config: {
        systemInstruction: SYSTEM_INSTRUCTION,
        tools: [{ googleSearch: {} }],
        temperature: 0.3,
      },
    });

    const text = response.text;
    const groundingMetadata = response.candidates?.[0]?.groundingMetadata;

    return { text, groundingMetadata };
  } catch (error: any) {
    console.error("Gemini API ì˜¤ë¥˜:", error);
    throw new Error(error.message || "ê²½ê¸° ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
  }
};

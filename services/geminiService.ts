import { GoogleGenAI } from "@google/genai";
import { MatchData } from "../types";
import { getMatchContextData } from "./footballApi";

const SYSTEM_INSTRUCTION = `
**Role (ì—­í• )**
ë‹¹ì‹ ì€ Google Gemini 3.0 Pro ê¸°ë°˜ì˜ **ì¶•êµ¬ ë°ì´í„° ë¶„ì„ ë° ë¦¬ìŠ¤í¬ í‰ê°€ ì „ë¬¸ AI**ì…ë‹ˆë‹¤. 
ë‹¹ì‹ ì€ ì‚¬ìš©ìê°€ ì œê³µí•œ **API-Footballì˜ ë°©ëŒ€í•œ ë°ì´í„°(ìµœê·¼ 30ê²½ê¸°, ìƒëŒ€ ì „ì , ìˆœìœ„, ì„ ìˆ˜ ìŠ¤íƒ¯)**ë¥¼ ë°”íƒ•ìœ¼ë¡œ ê²½ê¸°ë¥¼ ë¶„ì„í•©ë‹ˆë‹¤.
ë‹¨ìˆœí•œ ìŠ¹íŒ¨ ì˜ˆì¸¡ì´ ì•„ë‹ˆë¼, **"í‹€ë¦´ ê°€ëŠ¥ì„±ì„ í†µì œí•˜ëŠ” ì „ë¬¸ê°€"**ë¡œì„œ ë°ì´í„°ë¥¼ í•´ì„í•˜ê³ , ë¦¬ìŠ¤í¬ë¥¼ í‰ê°€í•˜ë©°, í•©ë¦¬ì ì¸ íŒë‹¨ì„ ë‚´ë¦½ë‹ˆë‹¤.

**Analysis Philosophy (ë¶„ì„ ì² í•™)**
1. **ë°ì´í„° ì‹¬ì¸µ ë¶„ì„(Deep Dive):** íŒ€ì˜ ì¥ê¸°ì ì¸ í¼(30ê²½ê¸°)ê³¼ ì„ ìˆ˜ ê°œì¸ì˜ ìŠ¤íƒ¯(ë“ì ë ¥, í‰ì  ë“±)ì„ ì¢…í•©ì ìœ¼ë¡œ ê³ ë ¤í•˜ì‹­ì‹œì˜¤.
2. **ì„ ìˆ˜ ì¤‘ì‹¬ í•´ì„:** íŒ€ ì´ë¦„ê°’ë³´ë‹¤ ì‹¤ì œ í™œì•½ ì¤‘ì¸ ì„ ìˆ˜ë“¤ì˜ ë°ì´í„°(Top Scorers, ìµœê·¼ í¼)ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë§¤ì¹˜ì—… ìš°ìœ„ë¥¼ íŒë‹¨í•˜ì‹­ì‹œì˜¤.
3. **ë¦¬ìŠ¤í¬ ê´€ë¦¬:** ë°ì´í„°ê°€ ìƒì¶©í•˜ê±°ë‚˜ ì£¼ìš” ì„ ìˆ˜ì˜ ë¶€ìƒ/ê²°ì¥ ë³€ìˆ˜ê°€ í¬ë‹¤ë©´ 'ê´€ë§(NO BET)'ì„ ê¶Œê³ í•˜ì‹­ì‹œì˜¤.

**Output Format (ì¶œë ¥ í˜•ì‹ - í•„ìˆ˜ ì¤€ìˆ˜)**
ëª¨ë“  ë¶„ì„ ê²°ê³¼ëŠ” ë°˜ë“œì‹œ ì•„ë˜ í¬ë§·ì„ ë”°ë¼ì•¼ í•˜ë©°, **í•œêµ­ì–´**ë¡œ ì‘ì„±í•˜ì‹­ì‹œì˜¤.

---
### ğŸŸï¸ ê²½ê¸° ë¶„ì„ ë¦¬í¬íŠ¸: [í™ˆíŒ€] vs [ì›ì •íŒ€]
**(ë°ì´í„° ì¶œì²˜: API-Football v3 - ìµœê·¼ 30ê²½ê¸° ë° ì„ ìˆ˜ ë°ì´í„°)**

### ğŸ“Š ë°ì´í„° íŒ©íŠ¸ ì²´í¬
- **ë¦¬ê·¸ í˜„í™©:** (ì–‘ íŒ€ì˜ í˜„ì¬ ìˆœìœ„, ìŠ¹ì  ì°¨ì´, ìµœê·¼ ê¸°ì„¸ ìš”ì•½)
- **í™ˆíŒ€ íë¦„:** (ìµœê·¼ 30ê²½ê¸° ìŠ¹ë¥  ë° í™ˆ ê°•ì„¸ ì—¬ë¶€)
- **ì›ì •íŒ€ íë¦„:** (ìµœê·¼ 30ê²½ê¸° ìŠ¹ë¥  ë° ì›ì • ì•½ì„¸ ì—¬ë¶€)
- **ìƒëŒ€ ì „ì  (H2H):** (ì—­ëŒ€ ì „ì ì˜ ìš°ì„¸/ì—´ì„¸)

### ğŸƒ ì„ ìˆ˜ ë° ë¼ì¸ì—… ë¶„ì„
- **í™ˆíŒ€ í•µì‹¬ ì„ ìˆ˜:** (ì œê³µëœ JSONì˜ ì„ ìˆ˜ ìŠ¤íƒ¯ì„ ë°”íƒ•ìœ¼ë¡œ ë“ì ì›/ì—ì´ìŠ¤ ë¶„ì„)
- **ì›ì •íŒ€ í•µì‹¬ ì„ ìˆ˜:** (ì œê³µëœ JSONì˜ ì„ ìˆ˜ ìŠ¤íƒ¯ì„ ë°”íƒ•ìœ¼ë¡œ ë“ì ì›/ì—ì´ìŠ¤ ë¶„ì„)
- **ë¶€ìƒ/ê²°ì¥ ë³€ìˆ˜:** (Google Searchë¥¼ í™œìš©í•˜ì—¬ í™•ì¸ëœ ìµœì‹  ë¶€ìƒì ëª…ë‹¨ ë° ì˜í–¥ë„)

### ğŸ§  ì „ìˆ ì  í•´ì„ ë° ë§¤ì¹˜ì—…
- **ê³µê²© vs ìˆ˜ë¹„:** (ë°ì´í„° ê¸°ë°˜ì˜ ì°½ê³¼ ë°©íŒ¨ ë¶„ì„)
- **ë§¤ì¹˜ì—… í¬ì¸íŠ¸:** (ì„ ìˆ˜ ê°„ì˜ ìƒì„±, ì˜ˆ: ë“ì  1ìœ„ ê³µê²©ìˆ˜ vs ì‹¤ì ì´ ë§ì€ ìˆ˜ë¹„ì§„)
- **ì‹œì¦Œ ë§¥ë½:** (ë™ê¸°ë¶€ì—¬ ìˆ˜ì¤€)

### âš ï¸ ë¦¬ìŠ¤í¬ í‰ê°€
- **ë¶ˆí™•ì‹¤ì„± ìš”ì†Œ:** (ì˜ˆ: ì£¼ì „ ê²°ì¥, ì²´ë ¥ ë¬¸ì œ, ë°ì´í„°ì˜ ë¶ˆì¼ì¹˜)
- **ê³¼ì‹  ê²½ê³ :** (í†µê³„ê°€ ê°€ë¦¬í‚¤ëŠ” í•¨ì •)

### âœ… ìµœì¢… íŒë‹¨
- **ì¶”ì²œ:** [BET (íŒ€ìŠ¹/ì˜¤ë²„/ì–¸ë”/í•¸ë””ìº¡) / NO BET / HIGH RISK]
- **ì˜ˆìƒ ìŠ¤ì½”ì–´:** (ì˜ˆ: 2-1)
- **í•µì‹¬ ê·¼ê±°:** (í•œ ì¤„ ìš”ì•½)
---
`;

export const analyzeMatch = async (matchData: MatchData, apiKey: string) => {
  if (!apiKey) throw new Error("API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.");

  const ai = new GoogleGenAI({ apiKey });
  const model = "gemini-2.5-flash"; 

  // 1. API-Footballì—ì„œ ì‹¤ì œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
  let footballData = null;
  let dataFetchError = null;
  
  try {
    footballData = await getMatchContextData(matchData.homeTeam, matchData.awayTeam);
  } catch (e: any) {
    console.warn("Football API ê°€ì ¸ì˜¤ê¸° ì˜¤ë¥˜:", e);
    dataFetchError = e.message;
  }

  // 2. í”„ë¡¬í”„íŠ¸ êµ¬ì„±
  let prompt = `
    ë‹¤ìŒ ì¶•êµ¬ ê²½ê¸°ë¥¼ ë¶„ì„í•´ ì£¼ì„¸ìš”: ${matchData.homeTeam} (í™ˆ) vs ${matchData.awayTeam} (ì›ì •).
    ê²½ê¸° ë‚ ì§œ/ë§¥ë½: ${matchData.date || "ì˜ˆì •ëœ ê²½ê¸°"}. ${matchData.context || ""}
  `;

  if (footballData) {
    prompt += `
      \n\n### API-FOOTBALL DATA (ì´ ë°ì´í„°ë¥¼ ìµœìš°ì„  ê·¼ê±°ë¡œ ì‚¬ìš©í•˜ì„¸ìš”):
      **í¬í•¨ëœ ë°ì´í„°:**
      1. í™ˆ/ì›ì • íŒ€ì˜ ìµœê·¼ 30ê²½ê¸° ê¸°ë¡ (Recent Matches)
      2. ë‘ íŒ€ ê°„ì˜ ìµœê·¼ 20ê²½ê¸° ìƒëŒ€ ì „ì  (Head to Head)
      3. í˜„ì¬ ë¦¬ê·¸ ìˆœìœ„í‘œ (Standings - ì´ìš© ê°€ëŠ¥í•œ ê²½ìš°)
      4. **ì–‘ íŒ€ ì£¼ìš” ì„ ìˆ˜ ìŠ¤íƒ¯ (Players - ë“ì , ë„ì›€, í‰ì  ë“±)**

      \`\`\`json
      ${JSON.stringify(footballData, null, 2)}
      \`\`\`
    `;
  } else {
    prompt += `\n\nê²½ê³ : API-Football ë°ì´í„°ë¥¼ ì§ì ‘ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤ (ì˜¤ë¥˜: ${dataFetchError}). ëŒ€ì‹  Google Search ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ìµœì‹  í†µê³„, ì„ ìˆ˜ ëª…ë‹¨, ë¶€ìƒì ì •ë³´ë¥¼ ì°¾ì•„ ë¶„ì„í•˜ì„¸ìš”.`;
  }

  prompt += `\në°˜ë“œì‹œ ì„ ìˆ˜ ë°ì´í„°(ë“ì , ì–´ì‹œìŠ¤íŠ¸, í‰ì  ë“±)ë¥¼ ë°˜ì˜í•˜ì—¬ ë¶„ì„í•˜ê³ , ì‹œìŠ¤í…œ ì§€ì¹¨ì— ì •ì˜ëœ ë¦¬í¬íŠ¸ í˜•ì‹ì„ ë”°ë¼ **í•œêµ­ì–´**ë¡œ ì¶œë ¥í•˜ì„¸ìš”.`;

  try {
    const response = await ai.models.generateContent({
      model,
      contents: prompt,
      config: {
        systemInstruction: SYSTEM_INSTRUCTION,
        tools: [{ googleSearch: {} }],
        temperature: 0.3,
      },
    });

    const text = response.text;
    const groundingMetadata = response.candidates?.[0]?.groundingMetadata;

    return { text, groundingMetadata };
  } catch (error: any) {
    console.error("Gemini API ì˜¤ë¥˜:", error);
    throw new Error(error.message || "ê²½ê¸° ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
  }
};